<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Avançado de Controle de Usinas Elétricas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chosen Palette: Dark Blue/Grey with Cyan, Red, Green, Purple Accents -->
    <!-- Application Structure Plan: The application is structured with a primary tab navigation system. The "Dados das Usinas" tab is now the default and first, providing immediate access to the tabular data. This is followed by the "Mapa Interativo" for geographical visualization. Subsequent tabs ("Controle Operacional", "Análise Gráfica", "Importação de Dados") offer specialized functionalities. This flow prioritizes data overview, then location-based context, and finally, operational interaction and analysis. Filtering by bar type is integrated into the data table for quick segmentation. Control panel changes directly update the underlying data, which then re-renders relevant UI components (table, map, charts), ensuring a cohesive and responsive user experience. -->
    <!-- Visualization & Content Choices:
        - Dados das Usinas: Report Info -> Tabular data of power plants. Goal -> Present detailed plant data, allow filtering. Viz/Method -> HTML table with dynamic content. Interaction -> Dropdown filter for 'Tipo de Barra'. Justification -> Tabular format is best for detailed, comparative data; filtering enhances exploration. Library/Method -> Vanilla JS.
        - Mapa Interativo: Report Info -> Geographical location of plants. Goal -> Visualize plant distribution and status. Viz/Method -> Leaflet.js map with markers and circles. Interaction -> Click markers for popups with plant details; reset view button. Justification -> Provides spatial context and quick overview of plant types/capacities. Library/Method -> Leaflet.js.
        - Controle Operacional: Report Info -> Parameters for generator/bus control. Goal -> Allow simulation of operational changes. Viz/Method -> HTML forms with sliders and select boxes. Interaction -> Sliders update values; select changes active generator; "Aplicar Configurações" button updates data and re-renders table/map/charts. Justification -> Direct manipulation of key parameters for scenario testing. Library/Method -> Vanilla JS.
        - Análise Gráfica: Report Info -> Summarized data (e.g., generation type distribution, plant capacity). Goal -> Provide visual insights into aggregated data. Viz/Method -> Chart.js Doughnut and Bar charts. Interaction -> Tooltips on hover. Justification -> Charts quickly convey trends and proportions. Library/Method -> Chart.js.
        - Importação de Dados: Report Info -> Instructions for Excel import. Goal -> Facilitate external data loading. Viz/Method -> Text instructions, file input. Interaction -> File selection triggers validation and data loading. Justification -> Essential for dynamic data management. Library/Method -> XLSX.js.
        - CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --control-color: #9b59b6;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --success-color: #27ae60;
            --warning-color: #f39c12;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a3a, #0d1b2a);
            color: #e0e0e0;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: rgba(13, 27, 42, 0.9);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            border: 1px solid rgba(52, 152, 219, 0.3);
            backdrop-filter: blur(10px);
        }
        
        header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #64b5f6;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        header p {
            opacity: 0.8;
            font-size: 1.1rem;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: rgba(30, 40, 56, 0.8);
            border-radius: 15px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
            padding: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(100, 181, 246, 0.2);
            backdrop-filter: blur(5px);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            background: rgba(35, 45, 65, 0.85);
        }
        
        .card h2 {
            color: #64b5f6;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .map-container {
            grid-column: 1 / -1;
            height: 500px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        
        #map {
            height: 100%;
            width: 100%;
            border-radius: 15px;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            margin: 25px 0;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--secondary-color), #2980b9);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(to right, var(--success-color), #219653);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(to right, var(--warning-color), #e67e22);
            color: white;
        }
        
        .btn-control {
            background: linear-gradient(to right, var(--control-color), #8e44ad);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 10px rgba(0,0,0,0.3);
            opacity: 0.95;
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .tooltip {
            position: absolute;
            bottom: -50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            width: 350px;
            font-size: 0.9rem;
            font-weight: normal;
            text-align: left;
            z-index: 1000;
            display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(100, 181, 246, 0.3);
        }
        
        .btn:hover .tooltip {
            display: block;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 25px;
            background: rgba(30, 40, 56, 0.8);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 1px solid rgba(52, 152, 219, 0.3);
            backdrop-filter: blur(5px);
        }
        
        .tab {
            padding: 18px 30px;
            cursor: pointer;
            background: rgba(40, 50, 70, 0.6);
            border: none;
            flex: 1;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #b0bec5;
            font-size: 1.05rem;
            position: relative;
            overflow: hidden;
        }
        
        .tab:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: transparent;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            background: rgba(50, 60, 80, 0.8);
            color: #e0e0e0;
        }
        
        .tab.active {
            background: rgba(30, 40, 56, 0.95);
            color: #64b5f6;
        }
        
        .tab.active:after {
            background: var(--secondary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 14px 18px;
            text-align: left;
            border-bottom: 1px solid rgba(100, 181, 246, 0.2);
        }
        
        th {
            background: rgba(26, 35, 50, 0.9);
            color: #64b5f6;
            position: sticky;
            top: 0;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background: rgba(35, 45, 65, 0.4);
        }
        
        tr:hover {
            background: rgba(52, 152, 219, 0.15);
        }
        
        .data-table {
            max-height: 500px;
            overflow-y: auto;
            border-radius: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        
        .stat-card {
            background: rgba(30, 40, 56, 0.7);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            text-align: center;
            border: 1px solid rgba(100, 181, 246, 0.2);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(35, 45, 65, 0.8);
        }
        
        .stat-card h3 {
            font-size: 1.25rem;
            color: #bb86fc;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #64ffda;
            margin: 10px 0;
        }
        
        .stat-subtitle {
            font-size: 1rem;
            color: #b0bec5;
        }
        
        footer {
            text-align: center;
            padding: 25px;
            color: #90a4ae;
            font-size: 0.95rem;
            margin-top: 30px;
            border-top: 1px solid rgba(100, 181, 246, 0.2);
            border-radius: 0 0 15px 15px;
            background: rgba(13, 27, 42, 0.8);
        }
        
        .highlight {
            background: rgba(155, 89, 182, 0.3);
            padding: 3px 8px;
            border-radius: 5px;
            color: #e1bee7;
        }
        
        .legend {
            background: rgba(30, 40, 56, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            border: 1px solid rgba(100, 181, 246, 0.3);
            backdrop-filter: blur(5px);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        
        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        
        .control-card {
            background: rgba(40, 50, 70, 0.8);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 1px solid rgba(100, 181, 246, 0.3);
        }
        
        .control-card h3 {
            color: #bb86fc;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(100, 181, 246, 0.2);
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: #b0bec5;
            font-weight: 500;
        }
        
        .control-group input, .control-group select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(100, 181, 246, 0.3);
            background: rgba(30, 40, 56, 0.7);
            color: #e0e0e0;
            font-size: 1rem;
        }
        
        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .slider-container input[type="range"] {
            flex: 1;
        }
        
        .slider-value {
            min-width: 60px;
            text-align: center;
            padding: 5px 10px;
            background: rgba(30, 40, 56, 0.7);
            border-radius: 5px;
            border: 1px solid rgba(100, 181, 246, 0.3);
        }
        
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
        }
        
        .import-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(30, 40, 56, 0.7);
            border-radius: 10px;
            border: 1px dashed rgba(100, 181, 246, 0.5);
        }
        
        .import-info h4 {
            color: #64b5f6;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .import-info ul {
            padding-left: 25px;
            margin: 10px 0;
        }
        
        .import-info li {
            margin-bottom: 8px;
            color: #b0bec5;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-active {
            background-color: var(--success-color);
            box-shadow: 0 0 8px var(--success-color);
        }
        
        .status-inactive {
            background-color: var(--accent-color);
        }

        /* Specific styles for Chart.js canvas containers */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px; /* Example max-width for charts */
            margin-left: auto;
            margin-right: auto;
            height: 300px; /* Base height, adjust with media queries */
            max-height: 400px; /* Max height to prevent excessive vertical growth */
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-bolt"></i> CASO 04 - Sistema Avançado de Controle de Usinas</h1>
            <p>Controle operacional de barras shunt, swing e geradores com gestão de MW e MVAR</p>
        </header>
        
        <div class="tabs">
            <button class="tab active" onclick="openTab('data-tab', this)"><i class="fas fa-table"></i> Dados das Usinas</button>
            <button class="tab" onclick="openTab('map-tab', this)"><i class="fas fa-map"></i> Mapa Interativo</button>
            <button class="tab" onclick="openTab('control-tab', this)"><i class="fas fa-sliders-h"></i> Controle Operacional</button>
            <button class="tab" onclick="openTab('charts-tab', this)"><i class="fas fa-chart-bar"></i> Análise Gráfica</button>
            <button class="tab" onclick="openTab('import-tab', this)"><i class="fas fa-file-import"></i> Importação de Dados</button>
        </div>
        
        <div id="data-tab" class="tab-content active">
            <div class="card">
                <h2><i class="fas fa-industry"></i> Dados das Usinas Elétricas</h2>
                <div class="controls">
                    <div class="control-group" style="flex-grow: 1;">
                        <label for="bar-type-filter">Filtrar por Tipo de Barra:</label>
                        <select id="bar-type-filter" onchange="filterAndDisplayPlants()">
                            <option value="Todos">Todos</option>
                            <option value="Swing">Swing (Referência)</option>
                            <option value="PV">PV (Geração/Tensão)</option>
                            <option value="PQ">PQ (Carga)</option>
                            <option value="Shunt">Shunt (Compensação)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="exportToExcel()" style="align-self: flex-end;">
                        <i class="fas fa-file-export"></i> Exportar para Excel
                    </button>
                </div>
                <div class="data-table">
                    <table id="power-plants-table">
                        <thead>
                            <tr>
                                <th>Nome da Usina</th>
                                <th>Barra</th>
                                <th>Tipo Barra</th>
                                <th>Potência Nominal (MW)</th>
                                <th>Despacho MW</th>
                                <th>Despacho Mvar</th>
                                <th>Vterm</th>
                                <th>Estado</th>
                                <th>Subsistema</th>
                                <th>Tipo Usina</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados serão preenchidos por JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="map-tab" class="tab-content">
            <div class="map-container">
                <div id="map"></div>
            </div>
            
            <div class="controls">
                <button class="btn btn-success" id="import-btn-map" onclick="document.getElementById('file-input').click()">
                    <i class="fas fa-file-import"></i> Importar Excel
                    <span class="tooltip">
                        <strong>Estrutura do Excel obrigatória:</strong><br>
                        - Planilha nomeada: <span class="highlight">Usinas</span><br>
                        - Colunas obrigatórias:<br>
                        &nbsp;&nbsp;• Nome da Usina<br>
                        &nbsp;&nbsp;• Número da Barra<br>
                        &nbsp;&nbsp;• Potência Nominal (MW)<br>
                        &nbsp;&nbsp;• Pmín Unidade (MW)<br>
                        &nbsp;&nbsp;• Pmáx Unidade (MW)<br>
                        &nbsp;&nbsp;• Qmin por Unidade (Mvar)<br>
                        &nbsp;&nbsp;• Qmáx por Unidade (Mvar)<br>
                        &nbsp;&nbsp;• Estado<br>
                        &nbsp;&nbsp;• Subsistema<br>
                        &nbsp;&nbsp;• Tipo de Usina<br>
                        &nbsp;&nbsp;• Despacho Atual MW (opcional)<br>
                        &nbsp;&nbsp;• Despacho Atual Mvar (opcional)<br>
                        &nbsp;&nbsp;• Vterm (opcional)<br>
                        &nbsp;&nbsp;• latitude (opcional)<br>
                        &nbsp;&nbsp;• longitude (opcional)<br>
                        &nbsp;&nbsp;• barType (opcional)
                    </span>
                </button>
                <input type="file" id="file-input" accept=".xlsx, .xls" style="display: none;">
                
                <button class="btn btn-warning" onclick="resetMapView()">
                    <i class="fas fa-sync-alt"></i> Resetar Visualização
                </button>
                <button class="btn btn-control" onclick="simulateOperation()">
                    <i class="fas fa-play"></i> Simular Operação
                </button>
            </div>
        </div>
        
        <div id="control-tab" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-cogs"></i> Controle Operacional Avançado</h2>
                
                <div class="control-panel">
                    <div class="control-card">
                        <h3><i class="fas fa-plug"></i> Controle de Geradores</h3>
                        
                        <div class="control-group">
                            <label for="generator-select">Selecione o Gerador:</label>
                            <select id="generator-select" onchange="updateGeneratorControl()">
                                <!-- Opções serão preenchidas por JavaScript -->
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label>Potência Ativa (MW):</label>
                            <div class="slider-container">
                                <input type="range" id="mw-control" min="0" max="100" step="1" value="0">
                                <span class="slider-value" id="mw-value">0 MW</span>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label>Potência Reativa (MVAR):</label>
                            <div class="slider-container">
                                <input type="range" id="mvar-control" min="-100" max="100" step="5" value="0">
                                <span class="slider-value" id="mvar-value">0 MVAR</span>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label>Tensão Terminal (Vterm):</label>
                            <div class="slider-container">
                                <input type="range" id="vterm-control" min="0.9" max="1.1" step="0.01" value="1.0">
                                <span class="slider-value" id="vterm-value">1.0 p.u.</span>
                            </div>
                        </div>
                        
                        <button class="btn btn-control" style="width:100%; margin-top:15px;" onclick="applyGeneratorSettings()">
                            <i class="fas fa-paper-plane"></i> Aplicar Configurações
                        </button>
                    </div>
                    
                    <div class="control-card">
                        <h3><i class="fas fa-bolt"></i> Controle de Barras</h3>
                        
                        <div class="control-group">
                            <label for="bus-select">Selecione a Barra:</label>
                            <select id="bus-select" onchange="updateBusControl()">
                                <!-- Opções serão preenchidas por JavaScript -->
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="bus-type-display">Tipo de Barra:</label>
                            <input type="text" id="bus-type-display" readonly style="background: rgba(30, 40, 56, 0.5); border: none;">
                        </div>
                        
                        <div class="control-group">
                            <label>Tensão da Barra (p.u.):</label>
                            <div class="slider-container">
                                <input type="range" id="bus-voltage" min="0.9" max="1.1" step="0.01" value="1.0">
                                <span class="slider-value" id="bus-voltage-value">1.0 p.u.</span>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label>Ângulo de Fase (graus):</label>
                            <div class="slider-container">
                                <input type="range" id="bus-angle" min="-10" max="10" step="0.5" value="0">
                                <span class="slider-value" id="bus-angle-value">0°</span>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label>Compensação Shunt (MVAR):</label>
                            <div class="slider-container">
                                <input type="range" id="shunt-control" min="-100" max="100" step="5" value="0">
                                <span class="slider-value" id="shunt-value">0 MVAR</span>
                            </div>
                        </div>
                        
                        <button class="btn btn-control" style="width:100%; margin-top:15px;" onclick="applyBusSettings()">
                            <i class="fas fa-paper-plane"></i> Aplicar Configurações
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="charts-tab" class="tab-content">
            <div class="dashboard">
                <div class="card">
                    <h2><i class="fas fa-chart-pie"></i> Distribuição por Tipo de Geração</h2>
                    <div class="chart-container">
                        <canvas id="generation-type-chart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h2><i class="fas fa-chart-line"></i> Capacidade por Usina (MW)</h2>
                    <div class="chart-container">
                        <canvas id="plant-capacity-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="import-tab" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-file-excel"></i> Importação de Dados do Excel</h2>
                
                <div class="import-info">
                    <h4><i class="fas fa-info-circle"></i> Instruções para Importação</h4>
                    <p>Para importar dados corretamente, seu arquivo Excel deve conter uma planilha chamada <span class="highlight">"Usinas"</span> e as seguintes colunas obrigatórias:</p>
                    
                    <ul>
                        <li><strong>Nome da Usina</strong></li>
                        <li><strong>Número da Barra</strong></li>
                        <li><strong>Potência Nominal (MW)</strong></li>
                        <li><strong>Pmín Unidade (MW)</strong></li>
                        <li><strong>Pmáx Unidade (MW)</strong></li>
                        <li><strong>Qmin por Unidade (Mvar)</strong></li>
                        <li><strong>Qmáx por Unidade (Mvar)</strong></li>
                        <li><strong>Estado</strong> (ex: "Ativa", "Inativa")</li>
                        <li><strong>Subsistema</strong> (ex: "Sul", "Sudeste")</li>
                        <li><strong>Tipo de Usina</strong> (ex: "Hidrelétrica", "Termelétrica", "Eólica", "Biomassa")</li>
                        <li><strong>Despacho Atual MW</strong> (opcional, será usado como `currentMW`)</li>
                        <li><strong>Despacho Atual Mvar</strong> (opcional, será usado como `currentMVAR`)</li>
                        <li><strong>Vterm</strong> (opcional, será usado como `currentVterm`)</li>
                        <li><strong>latitude</strong> (opcional, para o mapa)</li>
                        <li><strong>longitude</strong> (opcional, para o mapa)</li>
                        <li><strong>barType</strong> (opcional, ex: "Swing", "PV", "PQ", "Shunt")</li>
                    </ul>
                    
                    <p>O sistema validará automaticamente a estrutura do arquivo durante a importação.</p>
                </div>
                
                <div class="controls" style="margin-top:25px;">
                    <button class="btn btn-success" onclick="document.getElementById('file-input-import').click()" style="position:relative;">
                        <i class="fas fa-file-import"></i> Selecionar Arquivo Excel
                        <span class="tooltip">
                            <strong>Estrutura do Excel obrigatória:</strong><br>
                            - Planilha nomeada: <span class="highlight">Usinas</span><br>
                            - Colunas obrigatórias (na ordem):<br>
                            &nbsp;&nbsp;1. Nome da Usina<br>
                            &nbsp;&nbsp;2. Número da Barra<br>
                            &nbsp;&nbsp;3. Potência Nominal (MW)<br>
                            &nbsp;&nbsp;4. Pmín Unidade (MW)<br>
                            &nbsp;&nbsp;5. Pmáx Unidade (MW)<br>
                            &nbsp;&nbsp;6. Qmin por Unidade (Mvar)<br>
                            &nbsp;&nbsp;7. Qmáx por Unidade (Mvar)<br>
                            &nbsp;&nbsp;8. Estado<br>
                            &nbsp;&nbsp;9. Subsistema<br>
                            &nbsp;&nbsp;10. Tipo de Usina<br>
                            &nbsp;&nbsp;... e opcionais para despacho, Vterm, lat/long, barType
                        </span>
                    </button>
                    <input type="file" id="file-input-import" accept=".xlsx, .xls" style="display: none;">
                    
                    <button class="btn btn-primary" id="import-confirm-btn" disabled onclick="confirmImport()">
                        <i class="fas fa-upload"></i> Confirmar Importação
                    </button>
                </div>
                
                <div id="import-status" style="margin-top:25px; padding:15px; background:rgba(30,40,56,0.7); border-radius:10px; display:none;">
                    <h4><i class="fas fa-spinner fa-spin"></i> Processando Importação...</h4>
                    <p id="status-text">Validando estrutura do arquivo...</p>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Sistema Avançado de Controle de Usinas Elétricas - Caso 04 | Dados referentes ao ano de 2030</p>
            <p>Desenvolvido para operação do Sistema Interligado Nacional (SIN)</p>
        </footer>
    </div>

    <script>
        let powerPlants = []; // Global array to hold all plant data
        let mapInstance = null; // Global map instance
        let generationTypeChart = null; // Chart.js instance for generation type
        let plantCapacityChart = null; // Chart.js instance for plant capacity

        // Initial data (dummy data for demonstration, matching CSV headers)
        const initialPowerPlantsData = [
            {
                "Nome da Usina": "Tambaqui",
                "Número da Barra": 8615,
                "Potência Nominal (MW)": 39,
                "Pmín Unidade (MW)": 1.64,
                "Pmáx Unidade (MW)": 45,
                "Qmin por Unidade (Mvar)": -0.4,
                "Qmáx por Unidade (Mvar)": 1.3,
                "Despacho Atual MW": 30,
                "Despacho Atual Mvar": 0.5,
                "Vterm": 0.987,
                "Estado": "Ativa",
                "Subsistema": "SUL",
                "Tipo de Usina": "Hidrelétrica",
                "latitude": -25.5,
                "longitude": -49.3,
                "barType": "PV"
            },
            {
                "Nome da Usina": "Floresta",
                "Número da Barra": 8830,
                "Potência Nominal (MW)": 46,
                "Pmín Unidade (MW)": 1.45,
                "Pmáx Unidade (MW)": 46,
                "Qmin por Unidade (Mvar)": -0.4,
                "Qmáx por Unidade (Mvar)": 1.3,
                "Despacho Atual MW": 40,
                "Despacho Atual Mvar": 1.0,
                "Vterm": 1.0,
                "Estado": "Ativa",
                "Subsistema": "SUL",
                "Tipo de Usina": "Hidrelétrica",
                "latitude": -26.0,
                "longitude": -50.0,
                "barType": "PV"
            },
            {
                "Nome da Usina": "Solaris",
                "Número da Barra": 9100,
                "Potência Nominal (MW)": 120,
                "Pmín Unidade (MW)": 0,
                "Pmáx Unidade (MW)": 120,
                "Qmin por Unidade (Mvar)": -10,
                "Qmáx por Unidade (Mvar)": 10,
                "Despacho Atual MW": 80,
                "Despacho Atual Mvar": 5,
                "Vterm": 1.01,
                "Estado": "Ativa",
                "Subsistema": "NORDESTE",
                "Tipo de Usina": "Solar",
                "latitude": -8.0,
                "longitude": -35.0,
                "barType": "PQ" // Solar often treated as PQ (fixed P, Q)
            },
            {
                "Nome da Usina": "Ventus",
                "Número da Barra": 9200,
                "Potência Nominal (MW)": 150,
                "Pmín Unidade (MW)": 0,
                "Pmáx Unidade (MW)": 150,
                "Qmin por Unidade (Mvar)": -15,
                "Qmáx por Unidade (Mvar)": 15,
                "Despacho Atual MW": 100,
                "Despacho Atual Mvar": 8,
                "Vterm": 0.99,
                "Estado": "Ativa",
                "Subsistema": "SUL",
                "Tipo de Usina": "Eólica",
                "latitude": -30.0,
                "longitude": -51.0,
                "barType": "PQ" // Wind often treated as PQ
            },
            {
                "Nome da Usina": "Nucleon",
                "Número da Barra": 9300,
                "Potência Nominal (MW)": 1000,
                "Pmín Unidade (MW)": 800,
                "Pmáx Unidade (MW)": 1050,
                "Qmin por Unidade (Mvar)": -200,
                "Qmáx por Unidade (Mvar)": 300,
                "Despacho Atual MW": 950,
                "Despacho Atual Mvar": 150,
                "Vterm": 1.03,
                "Estado": "Ativa",
                "Subsistema": "SUDESTE",
                "Tipo de Usina": "Nuclear",
                "latitude": -23.0,
                "longitude": -44.0,
                "barType": "PV"
            },
            {
                "Nome da Usina": "Barra Swing Principal", // Not a power plant, but a conceptual "bus"
                "Número da Barra": 1,
                "Potência Nominal (MW)": 0, // No generation capacity
                "Pmín Unidade (MW)": 0,
                "Pmáx Unidade (MW)": 0,
                "Qmin por Unidade (Mvar)": 0,
                "Qmáx por Unidade (Mvar)": 0,
                "Despacho Atual MW": 0,
                "Despacho Atual Mvar": 0,
                "Vterm": 1.05, // Fixed voltage and angle
                "Estado": "Ativa",
                "Subsistema": "Geral",
                "Tipo de Usina": "Referência",
                "latitude": -15.0,
                "longitude": -48.0,
                "barType": "Swing"
            },
            {
                "Nome da Usina": "Compensador Shunt", // Not a power plant
                "Número da Barra": 500,
                "Potência Nominal (MW)": 0,
                "Pmín Unidade (MW)": 0,
                "Pmáx Unidade (MW)": 0,
                "Qmin por Unidade (Mvar)": -50,
                "Qmáx por Unidade (Mvar)": 50,
                "Despacho Atual MW": 0,
                "Despacho Atual Mvar": 20, // Initial compensation
                "Vterm": 1.00,
                "Estado": "Ativa",
                "Subsistema": "SUL",
                "Tipo de Usina": "Compensador",
                "latitude": -27.5,
                "longitude": -48.5,
                "barType": "Shunt"
            }
        ];

        // Function to initialize or update the entire application state and UI
        function initializeApp(data) {
            powerPlants = data; // Update the global data source
            fillPowerPlantsTable();
            initMap(); // Re-initialize map to clear old markers and add new ones
            createCharts(); // Re-create charts with new data
            initControls(); // Re-initialize control panel dropdowns
        }

        // Initialize with dummy data on load
        initializeApp(initialPowerPlantsData);

        // --- Funções de Controle de Abas ---
        function openTab(tabId, clickedElement = null) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            
            if (clickedElement) {
                clickedElement.classList.add('active');
            } else {
                // Fallback for programmatic calls if clickedElement is not passed
                const tabButton = document.querySelector(`.tab[onclick*="openTab('${tabId}')"]`);
                if (tabButton) {
                    tabButton.classList.add('active');
                }
            }
            
            if (tabId === 'map-tab' && mapInstance) {
                setTimeout(() => {
                    mapInstance.invalidateSize();
                }, 100);
            }
            // Re-render charts if switching to charts tab to ensure responsiveness
            if (tabId === 'charts-tab') {
                if (generationTypeChart) generationTypeChart.destroy();
                if (plantCapacityChart) plantCapacityChart.destroy();
                createCharts();
            }
        }

        // --- Funções do Mapa ---
        function initMap() {
            if (mapInstance) {
                mapInstance.remove(); // Remove existing map instance
            }
            mapInstance = L.map('map').setView([-22.9068, -43.1729], 5); // Centered on Brazil

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);
            
            powerPlants.forEach(plant => {
                if (plant.latitude && plant.longitude) {
                    const marker = L.marker([plant.latitude, plant.longitude]).addTo(mapInstance);
                    
                    marker.bindPopup(`
                        <div style="font-weight:bold; font-size:1.2rem; margin-bottom:10px;">${plant['Nome da Usina']}</div>
                        <div><span style="color:#64b5f6;">Tipo Usina:</span> ${plant['Tipo de Usina']}</div>
                        <div><span style="color:#64b5f6;">Tipo Barra:</span> ${plant.barType || 'Não Definido'}</div>
                        <div><span style="color:#64b5f6;">Potência Nominal:</span> ${plant['Potência Nominal (MW)'].toLocaleString()} MW</div>
                        <div><span style="color:#64b5f6;">Despacho Atual:</span> ${plant['Despacho Atual MW'].toLocaleString()} MW</div>
                        <div><span style="color:#64b5f6;">Estado:</span> ${plant.Estado}</div>
                        <div style="margin-top:10px;">
                            <button onclick="focusOnPlant('${plant['Nome da Usina']}')" style="background:#3498db; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">
                                <i class="fas fa-search"></i> Detalhes
                            </button>
                        </div>
                    `);
                    
                    const radius = Math.sqrt(plant['Potência Nominal (MW)']) * 15; // Scale radius by capacity
                    const circle = L.circle([plant.latitude, plant.longitude], {
                        color: getColorByType(plant['Tipo de Usina']),
                        fillColor: getColorByType(plant['Tipo de Usina']),
                        fillOpacity: 0.3,
                        radius: radius
                    }).addTo(mapInstance);
                }
            });
            
            const legend = L.control({position: 'bottomright'});
            
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <h4 style="margin-bottom:10px; color:#64b5f6;">Legenda</h4>
                    <div class="legend-item"><div class="legend-color" style="background:#3498db"></div> Hidrelétrica</div>
                    <div class="legend-item"><div class="legend-color" style="background:#e74c3c"></div> Termelétrica</div>
                    <div class="legend-item"><div class="legend-color" style="background:#2ecc71"></div> Eólica</div>
                    <div class="legend-item"><div class="legend-color" style="background:#f39c12"></div> Biomassa</div>
                    <div class="legend-item"><div class="legend-color" style="background:#9b59b6"></div> Nuclear</div>
                    <div class="legend-item"><div class="legend-color" style="background:#7f8c8d"></div> Outras</div>
                `;
                return div;
            };
            
            legend.addTo(mapInstance);
        }
        
        function getColorByType(type) {
            switch(type) {
                case 'Hidrelétrica': return '#3498db';
                case 'Termelétrica': return '#e74c3c';
                case 'Eólica': return '#2ecc71';
                case 'Biomassa': return '#f39c12';
                case 'Nuclear': return '#9b59b6';
                case 'Solar': return '#ffeb3b'; // Added Solar color
                default: return '#7f8c8d'; // Grey for 'Outras' or undefined
            }
        }
        
        function resetMapView() {
            if (mapInstance) {
                mapInstance.setView([-22.9068, -43.1729], 5); // Reset to initial view
            }
        }

        function focusOnPlant(plantName) {
            const plant = powerPlants.find(p => p['Nome da Usina'] === plantName);
            if (plant && mapInstance) {
                mapInstance.setView([plant.latitude, plant.longitude], 10);
                // Optionally open the popup
                mapInstance.eachLayer(layer => {
                    if (layer instanceof L.Marker && layer.getLatLng().lat === plant.latitude && layer.getLatLng().lng === plant.longitude) {
                        layer.openPopup();
                    }
                });
            }
        }

        // --- Funções da Tabela de Dados ---
        function fillPowerPlantsTable() {
            const tableBody = document.querySelector('#power-plants-table tbody');
            tableBody.innerHTML = '';
            
            const selectedBarType = document.getElementById('bar-type-filter').value;
            const filteredPlants = powerPlants.filter(plant => 
                selectedBarType === "Todos" || plant.barType === selectedBarType
            );

            filteredPlants.forEach(plant => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${plant['Nome da Usina']}</td>
                    <td>${plant['Número da Barra']}</td>
                    <td>${plant.barType || 'N/A'}</td>
                    <td>${plant['Potência Nominal (MW)'].toLocaleString()}</td>
                    <td>${(plant['Despacho Atual MW'] || 0).toLocaleString()}</td>
                    <td>${(plant['Despacho Atual Mvar'] || 0).toLocaleString()}</td>
                    <td>${(plant.Vterm || 'N/A')}</td>
                    <td><span class="status-indicator ${plant.Estado === 'Ativa' ? 'status-active' : 'status-inactive'}"></span> ${plant.Estado}</td>
                    <td>${plant.Subsistema || 'N/A'}</td>
                    <td>${plant['Tipo de Usina'] || 'N/A'}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function filterAndDisplayPlants() {
            fillPowerPlantsTable(); // Re-render table with current filter
        }
        
        // --- Funções de Gráficos ---
        function createCharts() {
            // Destroy existing charts if they exist to prevent memory leaks and re-render issues
            if (generationTypeChart) generationTypeChart.destroy();
            if (plantCapacityChart) plantCapacityChart.destroy();

            // Aggregate data for charts
            const typeCounts = {};
            const plantNames = [];
            const plantCapacities = [];

            powerPlants.forEach(plant => {
                const type = plant['Tipo de Usina'] || 'Outras';
                typeCounts[type] = (typeCounts[type] || 0) + plant['Potência Nominal (MW)'];
                plantNames.push(plant['Nome da Usina']);
                plantCapacities.push(plant['Potência Nominal (MW)']);
            });
            
            // Chart 1: Distribution by Generation Type
            const typeCtx = document.getElementById('generation-type-chart').getContext('2d');
            generationTypeChart = new Chart(typeCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(typeCounts).map(label => {
                        // Custom label wrapping for Chart.js
                        if (label.length > 16) {
                            const words = label.split(' ');
                            if (words.length > 1) {
                                return [words.slice(0, words.length / 2).join(' '), words.slice(words.length / 2).join(' ')];
                            }
                        }
                        return label;
                    }),
                    datasets: [{
                        data: Object.values(typeCounts),
                        backgroundColor: Object.keys(typeCounts).map(type => getColorByType(type)),
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#e0e0e0',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (Array.isArray(label)) { // Handle wrapped labels
                                        label = label.join(' ');
                                    }
                                    const value = context.raw || 0;
                                    const total = context.chart.getDatasetMeta(0).total;
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value.toLocaleString()} MW (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Chart 2: Capacity by Plant
            const capacityCtx = document.getElementById('plant-capacity-chart').getContext('2d');
            plantCapacityChart = new Chart(capacityCtx, {
                type: 'bar',
                data: {
                    labels: plantNames.map(label => {
                        if (label.length > 16) {
                            const words = label.split(' ');
                            if (words.length > 1) {
                                return [words.slice(0, words.length / 2).join(' '), words.slice(words.length / 2).join(' ')];
                            }
                        }
                        return label;
                    }),
                    datasets: [{
                        label: 'Capacidade (MW)',
                        data: plantCapacities,
                        backgroundColor: powerPlants.map(plant => getColorByType(plant['Tipo de Usina'])),
                        borderWidth: 0,
                        borderRadius: 5,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(100, 181, 246, 0.1)'
                            },
                            ticks: {
                                color: '#b0bec5'
                            },
                            title: {
                                display: true,
                                text: 'Megawatts (MW)',
                                color: '#b0bec5'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#b0bec5'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toLocaleString() + ' MW';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // --- Funções de Controle Operacional ---
        function initControls() {
            const generatorSelect = document.getElementById('generator-select');
            generatorSelect.innerHTML = '';
            const busSelect = document.getElementById('bus-select');
            busSelect.innerHTML = '';

            // Populate generator select (only actual generators)
            powerPlants.filter(p => p.barType === 'PV' || p.barType === 'Swing').forEach((plant, index) => {
                const option = document.createElement('option');
                option.value = powerPlants.indexOf(plant); // Use actual index in global array
                option.textContent = `${plant['Nome da Usina']} (${plant['Número da Barra']})`;
                generatorSelect.appendChild(option);
            });

            // Populate bus select (all types of buses)
            powerPlants.forEach((plant, index) => {
                const option = document.createElement('option');
                option.value = index; // Use actual index in global array
                option.textContent = `${plant['Nome da Usina']} (${plant['Número da Barra']}) - ${plant.barType || 'N/A'}`;
                busSelect.appendChild(option);
            });
            
            // Set initial values for sliders based on first generator/bus
            updateGeneratorControl();
            updateBusControl();

            // Add event listeners for sliders
            document.getElementById('mw-control').addEventListener('input', function() {
                document.getElementById('mw-value').textContent = `${this.value} MW`;
            });
            
            document.getElementById('mvar-control').addEventListener('input', function() {
                document.getElementById('mvar-value').textContent = `${this.value} MVAR`;
            });
            
            document.getElementById('vterm-control').addEventListener('input', function() {
                document.getElementById('vterm-value').textContent = `${parseFloat(this.value).toFixed(2)} p.u.`;
            });
            
            document.getElementById('bus-voltage').addEventListener('input', function() {
                document.getElementById('bus-voltage-value').textContent = `${parseFloat(this.value).toFixed(2)} p.u.`;
            });
            
            document.getElementById('bus-angle').addEventListener('input', function() {
                document.getElementById('bus-angle-value').textContent = `${this.value}°`;
            });
            
            document.getElementById('shunt-control').addEventListener('input', function() {
                document.getElementById('shunt-value').textContent = `${this.value} MVAR`;
            });
        }
        
        function updateGeneratorControl() {
            const generatorSelect = document.getElementById('generator-select');
            const selectedIndex = generatorSelect.value;
            const selectedPlant = powerPlants[selectedIndex];
            
            if (selectedPlant) {
                document.getElementById('mw-control').value = selectedPlant['Despacho Atual MW'] || 0;
                document.getElementById('mw-value').textContent = `${selectedPlant['Despacho Atual MW'] || 0} MW`;
                document.getElementById('mw-control').max = selectedPlant['Pmáx Unidade (MW)'];
                document.getElementById('mw-control').min = selectedPlant['Pmín Unidade (MW)'];
                
                document.getElementById('mvar-control').value = selectedPlant['Despacho Atual Mvar'] || 0;
                document.getElementById('mvar-value').textContent = `${selectedPlant['Despacho Atual Mvar'] || 0} MVAR`;
                document.getElementById('mvar-control').max = selectedPlant['Qmáx por Unidade (Mvar)'];
                document.getElementById('mvar-control').min = selectedPlant['Qmin por Unidade (Mvar)'];
                
                document.getElementById('vterm-control').value = selectedPlant.Vterm || 1.0;
                document.getElementById('vterm-value').textContent = `${parseFloat(selectedPlant.Vterm || 1.0).toFixed(2)} p.u.`;
            }
        }

        function applyGeneratorSettings() {
            const generatorSelect = document.getElementById('generator-select');
            const selectedIndex = generatorSelect.value;
            const selectedPlant = powerPlants[selectedIndex];

            if (selectedPlant) {
                selectedPlant['Despacho Atual MW'] = parseFloat(document.getElementById('mw-control').value);
                selectedPlant['Despacho Atual Mvar'] = parseFloat(document.getElementById('mvar-control').value);
                selectedPlant.Vterm = parseFloat(document.getElementById('vterm-control').value);

                alert(`Configurações aplicadas para ${selectedPlant['Nome da Usina']}.`);
                // Re-render relevant parts of the UI
                fillPowerPlantsTable();
                initMap(); // Update map markers/popups
                createCharts(); // Update charts if they use dispatch data
            }
        }

        function updateBusControl() {
            const busSelect = document.getElementById('bus-select');
            const selectedIndex = busSelect.value;
            const selectedBus = powerPlants[selectedIndex]; // Using powerPlants for bus data too for simplicity

            if (selectedBus) {
                document.getElementById('bus-type-display').value = selectedBus.barType || 'N/A';
                document.getElementById('bus-voltage').value = selectedBus.Vterm || 1.0;
                document.getElementById('bus-voltage-value').textContent = `${parseFloat(selectedBus.Vterm || 1.0).toFixed(2)} p.u.`;
                
                // Angle is typically only for Swing bus, or derived for others
                document.getElementById('bus-angle').value = 0; // Default or derived
                document.getElementById('bus-angle-value').textContent = `0°`;

                // Shunt compensation is specific to Shunt buses or can be applied at PQ/PV
                document.getElementById('shunt-control').value = selectedBus['Despacho Atual Mvar'] || 0;
                document.getElementById('shunt-value').textContent = `${selectedBus['Despacho Atual Mvar'] || 0} MVAR`;

                // Disable/enable controls based on bus type for realism
                document.getElementById('bus-voltage').disabled = (selectedBus.barType === 'Swing' || selectedBus.barType === 'PV');
                document.getElementById('bus-angle').disabled = (selectedBus.barType !== 'Swing');
                document.getElementById('shunt-control').disabled = (selectedBus.barType !== 'Shunt');
            }
        }

        function applyBusSettings() {
            const busSelect = document.getElementById('bus-select');
            const selectedIndex = busSelect.value;
            const selectedBus = powerPlants[selectedIndex];

            if (selectedBus) {
                if (selectedBus.barType === 'Swing' || selectedBus.barType === 'PV') {
                    selectedBus.Vterm = parseFloat(document.getElementById('bus-voltage').value);
                }
                if (selectedBus.barType === 'Swing') {
                    // In a real system, angle is set by Swing, not directly controlled like this
                    // For simulation, we can update a conceptual angle
                    // selectedBus.angle = parseFloat(document.getElementById('bus-angle').value);
                }
                if (selectedBus.barType === 'Shunt') {
                    selectedBus['Despacho Atual Mvar'] = parseFloat(document.getElementById('shunt-control').value);
                }

                alert(`Configurações aplicadas para a Barra ${selectedBus['Número da Barra']} (${selectedBus.barType}).`);
                fillPowerPlantsTable();
                initMap();
                createCharts();
            }
        }
        
        // --- Funções de Importação/Exportação ---
        let importedDataBuffer = null; // To hold the raw file data for confirmation

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(powerPlants.map(plant => ({
                "Nome da Usina": plant['Nome da Usina'],
                "Número da Barra": plant['Número da Barra'],
                "Potência Nominal (MW)": plant['Potência Nominal (MW)'],
                "Pmín Unidade (MW)": plant['Pmín Unidade (MW)'],
                "Pmáx Unidade (MW)": plant['Pmáx Unidade (MW)'],
                "Qmin por Unidade (Mvar)": plant['Qmin por Unidade (Mvar)'],
                "Qmáx por Unidade (Mvar)": plant['Qmáx por Unidade (Mvar)'],
                "Despacho Atual MW": plant['Despacho Atual MW'],
                "Despacho Atual Mvar": plant['Despacho Atual Mvar'],
                "Vterm": plant.Vterm,
                "Estado": plant.Estado,
                "Subsistema": plant.Subsistema,
                "Tipo de Usina": plant['Tipo de Usina'],
                "latitude": plant.latitude,
                "longitude": plant.longitude,
                "barType": plant.barType
            })));
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Usinas");
            
            XLSX.writeFile(wb, "usinas_eletricas_caso_04.xlsx");
            
            alert("Dados exportados com sucesso para 'usinas_eletricas_caso_04.xlsx'");
        }
        
        document.getElementById('file-input').addEventListener('change', handleFileSelect);
        document.getElementById('file-input-import').addEventListener('change', handleFileSelect);

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                importedDataBuffer = e.target.result; // Store data temporarily
                document.getElementById('import-confirm-btn').disabled = false;
                document.getElementById('import-status').style.display = 'block';
                document.getElementById('status-text').innerHTML = `<i class="fas fa-check-circle" style="color:#64ffda;"></i> Arquivo "${file.name}" pronto para importação. Clique em "Confirmar Importação".`;
            };
            reader.readAsArrayBuffer(file);
        }

        function confirmImport() {
            if (!importedDataBuffer) {
                alert("Nenhum arquivo selecionado ou pronto para importação.");
                return;
            }

            document.getElementById('import-confirm-btn').disabled = true;
            document.getElementById('status-text').innerHTML = `<i class="fas fa-spinner fa-spin"></i> Processando importação...`;

            const workbook = XLSX.read(importedDataBuffer, {type: 'array'});
            
            if (!workbook.SheetNames.includes("Usinas")) {
                document.getElementById('status-text').innerHTML = `<i class="fas fa-exclamation-triangle" style="color:var(--accent-color);"></i> Erro: O arquivo deve conter uma planilha chamada 'Usinas'.`;
                importedDataBuffer = null;
                return;
            }
            
            const worksheet = workbook.Sheets["Usinas"];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            const requiredColumns = [
                "Nome da Usina", "Número da Barra", "Potência Nominal (MW)",
                "Pmín Unidade (MW)", "Pmáx Unidade (MW)", "Qmin por Unidade (Mvar)",
                "Qmáx por Unidade (Mvar)", "Estado", "Subsistema", "Tipo de Usina"
            ];
            
            if (jsonData.length === 0) {
                document.getElementById('status-text').innerHTML = `<i class="fas fa-exclamation-triangle" style="color:var(--accent-color);"></i> Erro: A planilha 'Usinas' está vazia.`;
                importedDataBuffer = null;
                return;
            }

            const firstRow = jsonData[0];
            const missingColumns = requiredColumns.filter(col => !Object.keys(firstRow).includes(col));
            
            if (missingColumns.length > 0) {
                document.getElementById('status-text').innerHTML = `<i class="fas fa-exclamation-triangle" style="color:var(--accent-color);"></i> Erro: O arquivo está faltando as seguintes colunas obrigatórias: ${missingColumns.join(", ")}.`;
                importedDataBuffer = null;
                return;
            }
            
            // Map imported data to our internal structure, adding defaults if missing
            const newPowerPlantsData = jsonData.map(row => ({
                "Nome da Usina": row["Nome da Usina"],
                "Número da Barra": row["Número da Barra"],
                "Potência Nominal (MW)": parseFloat(row["Potência Nominal (MW)"]),
                "Pmín Unidade (MW)": parseFloat(row["Pmín Unidade (MW)"]),
                "Pmáx Unidade (MW)": parseFloat(row["Pmáx Unidade (MW)"]),
                "Qmin por Unidade (Mvar)": parseFloat(row["Qmin por Unidade (Mvar)"]),
                "Qmáx por Unidade (Mvar)": parseFloat(row["Qmáx por Unidade (Mvar)"]),
                "Despacho Atual MW": parseFloat(row["Despacho Atual MW"] || row["Potência Nominal (MW)"] * 0.8), // Default to 80% nominal if not provided
                "Despacho Atual Mvar": parseFloat(row["Despacho Atual Mvar"] || 0),
                "Vterm": parseFloat(row["Vterm"] || 1.0),
                "Estado": row.Estado,
                "Subsistema": row.Subsistema,
                "Tipo de Usina": row["Tipo de Usina"],
                "latitude": parseFloat(row.latitude || (-20 + Math.random() * 10)), // Placeholder if not provided
                "longitude": parseFloat(row.longitude || (-50 + Math.random() * 10)), // Placeholder if not provided
                "barType": row.barType || (row["Potência Nominal (MW)"] > 0 ? 'PV' : 'PQ') // Simple heuristic for barType
            }));

            document.getElementById('status-text').textContent = "Importando dados...";
            
            setTimeout(() => {
                initializeApp(newPowerPlantsData); // Update the app with new data
                document.getElementById('status-text').innerHTML = `
                    <span style="color:var(--success-color);"><i class="fas fa-check-circle"></i> Importação concluída com sucesso!</span><br>
                    ${newPowerPlantsData.length} usinas carregadas.
                `;
                importedDataBuffer = null; // Clear buffer
                setTimeout(() => {
                    document.getElementById('import-status').style.display = 'none';
                    alert("Dados importados com sucesso! O sistema foi atualizado.");
                }, 1500);
            }, 1000);
        }

        function simulateOperation() {
            alert("Simulação de operação iniciada. Em um sistema real, isso ativaria um algoritmo de despacho ou fluxo de potência.");
            // Example: Randomly adjust dispatch for a few plants
            powerPlants.forEach(plant => {
                if (plant.barType === 'PV' || plant.barType === 'Swing') {
                    const newMW = parseFloat((Math.random() * (plant['Pmáx Unidade (MW)'] - plant['Pmín Unidade (MW)']) + plant['Pmín Unidade (MW)']).toFixed(2));
                    const newMvar = parseFloat((Math.random() * (plant['Qmáx por Unidade (Mvar)'] - plant['Qmin por Unidade (Mvar)']) + plant['Qmin por Unidade (Mvar)']).toFixed(2));
                    plant['Despacho Atual MW'] = newMW;
                    plant['Despacho Atual Mvar'] = newMvar;
                    plant.Vterm = parseFloat((0.95 + Math.random() * 0.1).toFixed(2)); // Random Vterm between 0.95 and 1.05
                }
            });
            fillPowerPlantsTable();
            initMap();
            createCharts();
        }
        
        // --- Inicialização ao carregar o documento ---
        document.addEventListener('DOMContentLoaded', function() {
            // Initial render of the first tab
            openTab('data-tab', document.querySelector('.tab.active')); 
        });
    </script>
</body>
</html>
