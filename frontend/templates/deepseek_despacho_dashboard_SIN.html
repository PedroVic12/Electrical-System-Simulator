<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Despacho de Energia - ONS - 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
        }
        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto auto;
            gap: 20px;
            grid-template-areas:
                "header header"
                "table table"
                "map sidebar"
                "cards chart";
        }
        .header { grid-area: header; }
        .table-container { grid-area: table; }
        .map-container { grid-area: map; }
        .sidebar { grid-area: sidebar; }
        .cards-container { grid-area: cards; }
        .chart-container { grid-area: chart; }
        .bus-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(71, 85, 105, 0.5);
            transition: all 0.3s ease;
        }
        .bus-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .bus-card.swing {
            border: 2px solid #f59e0b;
            background: rgba(30, 41, 59, 0.9);
        }
        .map-tooltip {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            padding: 10px;
            font-size: 14px;
            backdrop-filter: blur(5px);
        }
        .leaflet-div-icon {
            background: transparent !important;
            border: none !important;
        }
        .voltage-indicator {
            position: relative;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        .voltage-fill {
            height: 100%;
            border-radius: 4px;
        }
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #334155;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
        }
        .generation-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .grid-stack {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        .region-tag {
            position: absolute;
            top: -10px;
            right: 10px;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 10;
        }
        .sankey-chart {
            background: rgba(30, 41, 59, 0.7);
            border-radius: 12px;
            padding: 15px;
            height: 100%;
        }
        #map {
            border-radius: 12px;
            overflow: hidden;
            height: 450px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }
        .card-header {
            border-bottom: 1px solid #334155;
            padding-bottom: 12px;
            margin-bottom: 12px;
        }
        .power-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .power-table th {
            background-color: #1e293b;
            color: #94a3b8;
            text-align: left;
            padding: 8px 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .power-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #334155;
        }
        .power-table tbody tr {
            background-color: rgba(30, 41, 59, 0.5);
        }
        .power-table tbody tr:nth-child(even) {
            background-color: rgba(30, 41, 59, 0.7);
        }
        .power-table tbody tr:hover {
            background-color: rgba(56, 71, 98, 0.7);
        }
        .table-container {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 12px;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid #334155;
        }
        .table-header {
            background: rgba(15, 23, 42, 0.9);
            padding: 15px;
            border-bottom: 1px solid #334155;
        }
        .highlight-row {
            background-color: rgba(245, 158, 11, 0.2) !important;
            outline: 2px solid #f59e0b;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-6">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Dados iniciais das usinas (barras)
        const initialPlantData = [
            {
                id: "N-101",
                name: "Tucuruí",
                busNumber: 101,
                nominalPower: 8370,
                minPower: 1000,
                maxPower: 8370,
                minReactive: -500,
                maxReactive: 500,
                currentDispatchMW: 7115,
                currentDispatchPercentage: 85,
                currentReactive: -39,
                voltage: 1.000,
                newDispatchMW: 7115,
                newDispatchPercentage: 85,
                forceMachines: null,
                dispatchSynchronous: null,
                maxDispatchMachines: 18,
                dispatchedMachines: 18,
                maxUnits: 23,
                status: "Operacional",
                subsystem: "Norte",
                plantType: "Hidráulica",
                river: "Rio Tocantins",
                basin: "Tocantins/Araguaia",
                influenceRegion: "Norte",
                dispatchVsInstalled: "85.0%",
                plantVsBasin: "32.5%",
                dispatchVsBasin: "28.7%",
                lineData: { pf: 0.98, circuit: 1, fromBus: "N-101", toBus: "N-102" },
                position: [-3.83, -49.67],
                isSwing: false
            },
            {
                id: "NE-205",
                name: "Sobradinho",
                busNumber: 205,
                nominalPower: 1050,
                minPower: 200,
                maxPower: 1050,
                minReactive: -300,
                maxReactive: 300,
                currentDispatchMW: 735,
                currentDispatchPercentage: 70,
                currentReactive: -45,
                voltage: 0.909,
                newDispatchMW: 735,
                newDispatchPercentage: 70,
                forceMachines: null,
                dispatchSynchronous: null,
                maxDispatchMachines: 6,
                dispatchedMachines: 6,
                maxUnits: 8,
                status: "Operacional",
                subsystem: "Nordeste",
                plantType: "Hidráulica",
                river: "Rio São Francisco",
                basin: "São Francisco",
                influenceRegion: "Nordeste",
                dispatchVsInstalled: "70.0%",
                plantVsBasin: "15.8%",
                dispatchVsBasin: "11.2%",
                lineData: { pf: 0.95, circuit: 2, fromBus: "NE-205", toBus: "NE-206" },
                position: [-9.42, -40.82],
                isSwing: false
            },
            {
                id: "SE-301",
                name: "Itaipu",
                busNumber: 301,
                nominalPower: 14000,
                minPower: 7000,
                maxPower: 14000,
                minReactive: -800,
                maxReactive: 800,
                currentDispatchMW: 12880,
                currentDispatchPercentage: 92,
                currentReactive: -120,
                voltage: 0.998,
                newDispatchMW: 12880,
                newDispatchPercentage: 92,
                forceMachines: null,
                dispatchSynchronous: null,
                maxDispatchMachines: 20,
                dispatchedMachines: 20,
                maxUnits: 20,
                status: "Operacional",
                subsystem: "Sudeste",
                plantType: "Hidráulica",
                river: "Rio Paraná",
                basin: "Paraná",
                influenceRegion: "Sudeste",
                dispatchVsInstalled: "92.0%",
                plantVsBasin: "22.5%",
                dispatchVsBasin: "20.7%",
                lineData: { pf: 0.99, circuit: 1, fromBus: "SE-301", toBus: "SE-302" },
                position: [-25.41, -54.59],
                isSwing: false
            },
            {
                id: "SE-302",
                name: "Furnas",
                busNumber: 302,
                nominalPower: 0,
                minPower: 0,
                maxPower: 0,
                minReactive: -600,
                maxReactive: 600,
                currentDispatchMW: 0,
                currentDispatchPercentage: 0,
                currentReactive: 245,
                voltage: 1.050,
                newDispatchMW: 0,
                newDispatchPercentage: 0,
                forceMachines: null,
                dispatchSynchronous: null,
                maxDispatchMachines: 0,
                dispatchedMachines: 0,
                maxUnits: 0,
                status: "Operacional",
                subsystem: "Sudeste",
                plantType: "Subestação",
                river: "N/A",
                basin: "N/A",
                influenceRegion: "Sudeste",
                dispatchVsInstalled: "N/A",
                plantVsBasin: "N/A",
                dispatchVsBasin: "N/A",
                lineData: { pf: 1.00, circuit: 3, fromBus: "SE-302", toBus: "S-401" },
                position: [-20.27, -46.0],
                isSwing: true
            },
            {
                id: "S-401",
                name: "Itá",
                busNumber: 401,
                nominalPower: 1450,
                minPower: 300,
                maxPower: 1450,
                minReactive: -350,
                maxReactive: 350,
                currentDispatchMW: 1131,
                currentDispatchPercentage: 78,
                currentReactive: -85,
                voltage: 0.980,
                newDispatchMW: 1131,
                newDispatchPercentage: 78,
                forceMachines: null,
                dispatchSynchronous: null,
                maxDispatchMachines: 8,
                dispatchedMachines: 8,
                maxUnits: 10,
                status: "Operacional",
                subsystem: "Sul",
                plantType: "Hidráulica",
                river: "Rio Uruguai",
                basin: "Uruguai",
                influenceRegion: "Sul",
                dispatchVsInstalled: "78.0%",
                plantVsBasin: "18.7%",
                dispatchVsBasin: "14.6%",
                lineData: { pf: 0.97, circuit: 2, fromBus: "S-401", toBus: "S-402" },
                position: [-27.07, -52.32],
                isSwing: false
            },
            {
                id: "S-402",
                name: "Garibaldi",
                busNumber: 402,
                nominalPower: 189,
                minPower: 45,
                maxPower: 63,
                minReactive: -32,
                maxReactive: 32,
                currentDispatchMW: 180,
                currentDispatchPercentage: 95,
                currentReactive: -15,
                voltage: 0.995,
                newDispatchMW: 180,
                newDispatchPercentage: 95,
                forceMachines: null,
                dispatchSynchronous: null,
                maxDispatchMachines: 3,
                dispatchedMachines: 3,
                maxUnits: 3,
                status: "Operacional",
                subsystem: "Sul",
                plantType: "Hidráulica",
                river: "Rio Canoas",
                basin: "Rio Uruguai",
                influenceRegion: "Sul",
                dispatchVsInstalled: "95.2%",
                plantVsBasin: "3.2%",
                dispatchVsBasin: "0.0%",
                lineData: { pf: 0.96, circuit: 1, fromBus: "S-402", toBus: "S-401" },
                position: [-27.57, -51.67],
                isSwing: false
            },
            {
                id: "S-403",
                name: "Gov. José Richa (Salto Caxias)",
                busNumber: 403,
                nominalPower: 1240,
                minPower: 235,
                maxPower: 310,
                minReactive: -150,
                maxReactive: 112,
                currentDispatchMW: 1100,
                currentDispatchPercentage: 89,
                currentReactive: -75,
                voltage: 0.975,
                newDispatchMW: 1100,
                newDispatchPercentage: 89,
                forceMachines: null,
                dispatchSynchronous: null,
                maxDispatchMachines: 4,
                dispatchedMachines: 4,
                maxUnits: 4,
                status: "Operacional",
                subsystem: "Sul",
                plantType: "Hidráulica",
                river: "Rio Iguaçu",
                basin: "Bacia do Iguaçu",
                influenceRegion: "Sul",
                dispatchVsInstalled: "89.0%",
                plantVsBasin: "15.3%",
                dispatchVsBasin: "13.6%",
                lineData: { pf: 0.94, circuit: 2, fromBus: "S-403", toBus: "S-401" },
                position: [-25.78, -53.47],
                isSwing: false
            }
        ];

        // Configurações de cores por região
        const regionColors = {
            "Norte": "#3b82f6",
            "Nordeste": "#ef4444",
            "Sudeste": "#10b981",
            "Sul": "#8b5cf6"
        };

        // Classe Repository para gerenciar os dados
        class BusRepository {
            constructor() {
                this.storageKey = 'powerDispatchData_v1';
                this.data = this.loadFromStorage();
            }
            
            loadFromStorage() {
                try {
                    const data = localStorage.getItem(this.storageKey);
                    return data ? JSON.parse(data) : initialPlantData;
                } catch (e) {
                    return initialPlantData;
                }
            }
            
            saveToStorage() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                } catch (e) {
                    console.error("Erro ao salvar dados:", e);
                }
            }
            
            getAll() {
                return this.data;
            }
            
            updatePlant(id, updates) {
                this.data = this.data.map(plant => 
                    plant.id === id ? { ...plant, ...updates } : plant
                );
                this.saveToStorage();
                return this.data;
            }
            
            updateAll(newData) {
                this.data = newData;
                this.saveToStorage();
                return this.data;
            }
            
            // Função para despacho automático
            autoDispatch() {
                const swingBus = this.data.find(plant => plant.isSwing);
                if (!swingBus) return this.data;
                
                // Lógica simplificada de despacho automático
                const updatedData = this.data.map(plant => {
                    if (plant.plantType === "Hidráulica") {
                        const newDispatch = Math.min(
                            plant.maxPower, 
                            Math.max(plant.minPower, plant.nominalPower * 0.9)
                        );
                        const newPercentage = Math.round((newDispatch / plant.nominalPower) * 100);
                        
                        return {
                            ...plant,
                            newDispatchMW: newDispatch,
                            newDispatchPercentage: newPercentage
                        };
                    }
                    return plant;
                });
                
                this.data = updatedData;
                this.saveToStorage();
                return this.data;
            }
        }

        // Componente para a tabela de usinas
        const PowerPlantTable = ({ plants, onSelectPlant }) => {
            const [selectedId, setSelectedId] = useState(null);
            
            const handleSelect = (id) => {
                setSelectedId(id);
                onSelectPlant(id);
            };
            
            return (
                <div className="table-container">
                    <div className="table-header">
                        <h2 className="text-xl font-bold text-white">Tabela de Usinas e Barras</h2>
                        <p className="text-slate-400 text-sm">
                            {plants.length} usinas monitoradas | Clique em uma linha para destacar no mapa
                        </p>
                    </div>
                    <table className="power-table">
                        <thead>
                            <tr>
                                <th>Nome da Usina</th>
                                <th>Número da Barra</th>
                                <th>Potência Nominal (MW)</th>
                                <th>Pmín Unidade (MW)</th>
                                <th>Pmáx Unidade (MW)</th>
                                <th>Qmin (Mvar)</th>
                                <th>Qmáx (Mvar)</th>
                                <th>Despacho Atual (MW)</th>
                                <th>Despacho Atual (%)</th>
                                <th>Despacho Novo (MW)</th>
                                <th>Despacho Novo (%)</th>
                                <th>Estado</th>
                                <th>Subsistema</th>
                                <th>Tipo de Usina</th>
                            </tr>
                        </thead>
                        <tbody>
                            {plants.map(plant => (
                                <tr 
                                    key={plant.id}
                                    onClick={() => handleSelect(plant.id)}
                                    className={selectedId === plant.id ? "highlight-row" : ""}
                                >
                                    <td>{plant.name}</td>
                                    <td>{plant.busNumber}</td>
                                    <td>{plant.nominalPower.toLocaleString('pt-BR')}</td>
                                    <td>{plant.minPower.toLocaleString('pt-BR')}</td>
                                    <td>{plant.maxPower.toLocaleString('pt-BR')}</td>
                                    <td>{plant.minReactive}</td>
                                    <td>{plant.maxReactive}</td>
                                    <td>{plant.currentDispatchMW.toLocaleString('pt-BR')}</td>
                                    <td>{plant.currentDispatchPercentage}%</td>
                                    <td>{plant.newDispatchMW.toLocaleString('pt-BR')}</td>
                                    <td>{plant.newDispatchPercentage}%</td>
                                    <td>{plant.status}</td>
                                    <td>{plant.subsystem}</td>
                                    <td>{plant.plantType}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        // Componente para o card de barra
        const BusCard = ({ bus, onDispatchChange }) => {
            const voltagePercentage = Math.min(100, Math.max(0, (bus.voltage - 0.9) * 100));
            
            return (
                <div className={`bus-card rounded-xl p-5 relative overflow-hidden ${bus.isSwing ? 'swing' : ''}`}>
                    {bus.isSwing && (
                        <div className="region-tag" style={{ backgroundColor: "#f59e0b", color: "#1e293b" }}>
                            <i className="fas fa-bolt mr-1"></i> Barra Swing
                        </div>
                    )}
                    
                    <div className="flex justify-between items-start mb-4">
                        <div>
                            <h3 className="text-xl font-bold text-white">{bus.name}</h3>
                            <div className="flex items-center mt-1">
                                <span className="text-sm text-slate-300 mr-2">Barra {bus.busNumber}</span>
                                <span className="generation-badge" style={{ 
                                    backgroundColor: regionColors[bus.subsystem] + '20', 
                                    color: regionColors[bus.subsystem],
                                    border: `1px solid ${regionColors[bus.subsystem]}`
                                }}>
                                    {bus.subsystem}
                                </span>
                            </div>
                        </div>
                        <div className="text-right">
                            <span className="text-2xl font-bold" style={{ color: regionColors[bus.subsystem] }}>
                                {bus.voltage} pu
                            </span>
                            <div className="voltage-indicator w-24 bg-slate-700 mt-1">
                                <div 
                                    className="voltage-fill" 
                                    style={{ 
                                        width: `${voltagePercentage}%`, 
                                        background: `linear-gradient(90deg, ${regionColors[bus.subsystem]}, ${regionColors[bus.subsystem]}bb)`
                                    }}
                                ></div>
                            </div>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div className="bg-slate-800 rounded-lg p-3">
                            <div className="text-slate-400 text-sm mb-1">Carga MW</div>
                            <div className="text-lg font-bold text-blue-300">
                                {bus.currentDispatchMW.toLocaleString('pt-BR')}
                            </div>
                        </div>
                        <div className="bg-slate-800 rounded-lg p-3">
                            <div className="text-slate-400 text-sm mb-1">Carga Mvar</div>
                            <div className="text-lg font-bold text-purple-300">
                                {bus.currentReactive.toLocaleString('pt-BR')}
                            </div>
                        </div>
                    </div>
                    
                    {bus.plantType === "Hidráulica" && (
                        <div className="mb-4">
                            <div className="flex justify-between text-sm text-slate-400 mb-2">
                                <span>Despacho de Geração</span>
                                <span>{bus.newDispatchPercentage}% ({bus.newDispatchMW.toLocaleString('pt-BR')} MW)</span>
                            </div>
                            <input 
                                type="range" 
                                min={bus.minPower} 
                                max={bus.maxPower} 
                                value={bus.newDispatchMW} 
                                onChange={(e) => onDispatchChange(bus.id, parseInt(e.target.value))}
                                className="mb-2"
                                style={{ background: `linear-gradient(90deg, ${regionColors[bus.subsystem]} 0%, ${regionColors[bus.subsystem]} ${bus.newDispatchPercentage}%, #334155 ${bus.newDispatchPercentage}%, #334155 100%)` }}
                            />
                            <div className="text-sm text-slate-400 flex justify-between">
                                <span>{bus.plantType}</span>
                                <span>Capacidade: {bus.nominalPower.toLocaleString('pt-BR')} MW</span>
                            </div>
                        </div>
                    )}
                    
                    {bus.isSwing && (
                        <div className="mt-4 pt-3 border-t border-slate-700">
                            <h4 className="font-bold text-slate-300 mb-2">Controle de Tensão (Barra Swing)</h4>
                            <div className="flex items-center">
                                <button className="bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-1 px-3 rounded-l-lg">
                                    <i className="fas fa-minus"></i>
                                </button>
                                <div className="flex-1 text-center mx-2">
                                    <div className="text-xl font-bold text-amber-400">{bus.voltage} pu</div>
                                    <div className="text-xs text-slate-400">Tensão Atual</div>
                                </div>
                                <button className="bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-1 px-3 rounded-r-lg">
                                    <i className="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Componente do mapa do Brasil
        const BrazilMap = ({ plants, onSelectPlant }) => {
            const mapRef = useRef(null);
            const markersRef = useRef([]);
            
            useEffect(() => {
                // Inicializa o mapa
                mapRef.current = L.map('map').setView([-14.2350, -51.9253], 4);
                
                // Adiciona camada do mapa
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(mapRef.current);
                
                // Adiciona marcadores para cada usina
                markersRef.current = plants.map(plant => {
                    const marker = L.marker(plant.position, {
                        icon: L.divIcon({
                            className: 'leaflet-div-icon',
                            html: `
                                <div style="position: relative;">
                                    <div style="
                                        width: 24px; 
                                        height: 24px; 
                                        background: ${regionColors[plant.subsystem]};
                                        border-radius: 50%;
                                        border: 2px solid white;
                                        box-shadow: 0 0 10px rgba(0,0,0,0.3);
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-weight: bold;
                                        font-size: 10px;
                                    ">
                                        ${plant.busNumber}
                                    </div>
                                    ${plant.isSwing ? `
                                    <div style="
                                        position: absolute;
                                        top: -5px;
                                        right: -5px;
                                        width: 16px;
                                        height: 16px;
                                        background: #f59e0b;
                                        border-radius: 50%;
                                        border: 2px solid white;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                    ">
                                        <i class="fas fa-bolt" style="font-size: 8px; color: white;"></i>
                                    </div>` : ''}
                                </div>
                            `,
                            iconSize: [24, 24]
                        })
                    }).addTo(mapRef.current);
                    
                    marker.bindTooltip(`
                        <div class="map-tooltip">
                            <strong>${plant.name}</strong> (Barra ${plant.busNumber})<br>
                            <span style="color: ${regionColors[plant.subsystem]}">${plant.subsystem}</span><br>
                            ${plant.plantType === "Hidráulica" ? `Geração: ${plant.newDispatchMW} MW` : `Subestação`}
                        </div>
                    `);
                    
                    marker.on('click', () => onSelectPlant(plant.id));
                    
                    return marker;
                });
                
                // Adiciona contornos das regiões
                const regionBounds = {
                    "Norte": [[5, -74], [-20, -46]],
                    "Nordeste": [[1, -47], [-18, -34]],
                    "Sudeste": [[-14, -53], [-25, -41]],
                    "Sul": [[-22, -58], [-34, -48]]
                };
                
                Object.entries(regionBounds).forEach(([region, bounds]) => {
                    const rect = L.rectangle(bounds, {
                        color: regionColors[region],
                        fillColor: regionColors[region] + '20',
                        fillOpacity: 0.2,
                        weight: 2,
                        dashArray: '5, 5'
                    }).addTo(mapRef.current);
                    
                    rect.bindTooltip(`<div class="map-tooltip"><strong>${region}</strong></div>`);
                });
                
                return () => {
                    if (mapRef.current) {
                        mapRef.current.remove();
                    }
                };
            }, []);
            
            return <div id="map" className="w-full"></div>;
        };

        // Componente de resumo do sistema
        const SystemSummary = ({ plants, onAutoDispatch, onApplyChanges }) => {
            // Calcular totais por subsistema
            const subsystemTotals = {
                "Norte": { loadMW: 0, loadMvar: 0, generationMW: 0 },
                "Nordeste": { loadMW: 0, loadMvar: 0, generationMW: 0 },
                "Sudeste": { loadMW: 0, loadMvar: 0, generationMW: 0 },
                "Sul": { loadMW: 0, loadMvar: 0, generationMW: 0 }
            };
            
            plants.forEach(plant => {
                subsystemTotals[plant.subsystem].loadMW += plant.currentDispatchMW;
                subsystemTotals[plant.subsystem].loadMvar += plant.currentReactive;
                subsystemTotals[plant.subsystem].generationMW += plant.plantType === "Hidráulica" ? plant.newDispatchMW : 0;
            });
            
            // Calcular totais gerais
            const totalLoadMW = Object.values(subsystemTotals).reduce((sum, region) => sum + region.loadMW, 0);
            const totalLoadMvar = Object.values(subsystemTotals).reduce((sum, region) => sum + region.loadMvar, 0);
            const totalGenerationMW = Object.values(subsystemTotals).reduce((sum, region) => sum + region.generationMW, 0);
            const balanceMW = totalGenerationMW - totalLoadMW;
            
            return (
                <div className="bg-slate-800 rounded-xl p-5 h-full">
                    <div className="card-header">
                        <h2 className="text-xl font-bold text-white">Resumo do Sistema</h2>
                        <p className="text-slate-400 text-sm">Dados consolidados de carga e geração</p>
                    </div>
                    
                    <div className="mb-5">
                        <div className="flex justify-between mb-1">
                            <span className="text-slate-400">Carga Total:</span>
                            <span className="font-bold text-blue-300">{totalLoadMW.toLocaleString('pt-BR')} MW</span>
                        </div>
                        <div className="flex justify-between mb-1">
                            <span className="text-slate-400">Geração Total:</span>
                            <span className="font-bold text-green-300">{totalGenerationMW.toLocaleString('pt-BR')} MW</span>
                        </div>
                        <div className="flex justify-between mb-1">
                            <span className="text-slate-400">Balanço:</span>
                            <span className={`font-bold ${balanceMW >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                {balanceMW >= 0 ? '+' : ''}{balanceMW.toLocaleString('pt-BR')} MW
                            </span>
                        </div>
                        <div className="flex justify-between">
                            <span className="text-slate-400">Carga Reativa:</span>
                            <span className="font-bold text-purple-300">{totalLoadMvar.toLocaleString('pt-BR')} Mvar</span>
                        </div>
                    </div>
                    
                    <div className="mb-5">
                        <h3 className="font-bold text-slate-300 mb-3">Resumo por Subsistema</h3>
                        {Object.entries(subsystemTotals).map(([subsystem, data]) => (
                            <div key={subsystem} className="mb-3">
                                <div className="flex justify-between mb-1">
                                    <div className="flex items-center">
                                        <div className="w-3 h-3 rounded-full mr-2" style={{ backgroundColor: regionColors[subsystem] }}></div>
                                        <span className="text-slate-300">{subsystem}</span>
                                    </div>
                                    <span className="text-slate-400">{data.generationMW > 0 ? 'Geração' : 'Carga'}</span>
                                </div>
                                <div className="flex justify-between">
                                    <div className="w-full bg-slate-700 rounded-full h-2.5 mr-2">
                                        <div 
                                            className="h-2.5 rounded-full" 
                                            style={{ 
                                                width: `${(data.generationMW > 0 ? data.generationMW : data.loadMW) / 15000 * 100}%`, 
                                                background: `linear-gradient(90deg, ${regionColors[subsystem]}, ${regionColors[subsystem]}bb)`
                                            }}
                                        ></div>
                                    </div>
                                    <span className="font-bold text-sm">
                                        {data.generationMW > 0 
                                            ? data.generationMW.toLocaleString('pt-BR') + ' MW' 
                                            : data.loadMW.toLocaleString('pt-BR') + ' MW'}
                                    </span>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <div className="flex justify-between">
                        <button 
                            className="bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-2 px-4 rounded-lg flex items-center"
                            onClick={onAutoDispatch}
                        >
                            <i className="fas fa-bolt mr-2"></i> Despacho Automático
                        </button>
                        <button 
                            className="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg flex items-center"
                            onClick={onApplyChanges}
                        >
                            <i className="fas fa-check mr-2"></i> Aplicar Alterações
                        </button>
                    </div>
                </div>
            );
        };

        // Componente principal
        const App = () => {
            const busRepo = useRef(new BusRepository());
            const [plants, setPlants] = useState(busRepo.current.getAll());
            const [selectedPlant, setSelectedPlant] = useState(null);
            const [flowData, setFlowData] = useState([
                { source: "Norte", target: "Nordeste", value: 3200 },
                { source: "Norte", target: "Sudeste", value: 4200 },
                { source: "Nordeste", target: "Sudeste", value: 2800 },
                { source: "Sudeste", target: "Sul", value: 3800 },
                { source: "Sul", target: "Sudeste", value: 1500 }
            ]);
            
            const handleDispatchChange = (plantId, newMW) => {
                const updatedPlants = busRepo.current.updatePlant(plantId, {
                    newDispatchMW: newMW,
                    newDispatchPercentage: Math.round((newMW / plants.find(p => p.id === plantId).nominalPower) * 100)
                });
                setPlants(updatedPlants);
            };
            
            const handlePlantSelect = (plantId) => {
                setSelectedPlant(plantId);
                
                // Scroll para o card selecionado
                setTimeout(() => {
                    const element = document.getElementById(`plant-${plantId}`);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        element.classList.add('ring-2', 'ring-amber-400');
                        setTimeout(() => element.classList.remove('ring-2', 'ring-amber-400'), 2000);
                    }
                }, 100);
            };
            
            const handleAutoDispatch = () => {
                const updatedPlants = busRepo.current.autoDispatch();
                setPlants(updatedPlants);
            };
            
            const handleApplyChanges = () => {
                // Atualizar o despacho atual com os novos valores
                const updatedPlants = plants.map(plant => ({
                    ...plant,
                    currentDispatchMW: plant.newDispatchMW,
                    currentDispatchPercentage: plant.newDispatchPercentage
                }));
                
                busRepo.current.updateAll(updatedPlants);
                setPlants(updatedPlants);
                
                // Simular atualização do fluxo de energia
                setFlowData(prev => prev.map(flow => ({
                    ...flow,
                    value: Math.round(flow.value * (0.9 + Math.random() * 0.2))
                })));
            };
            
            return (
                <div className="max-w-7xl mx-auto">
                    <header className="header mb-8">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h1 className="text-3xl md:text-4xl font-bold text-white">
                                    <i className="fas fa-bolt text-amber-400 mr-3"></i>
                                    Painel de Despacho de Energia - ONS
                                </h1>
                                <p className="mt-2 text-slate-400">
                                    Controle e monitoramento do Sistema Interligado Nacional
                                </p>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="bg-slate-800 px-4 py-2 rounded-lg">
                                    <div className="text-slate-400 text-sm">Data/Hora</div>
                                    <div className="text-white font-medium">05/07/2025 14:45:32</div>
                                </div>
                                <button className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                                    <i className="fas fa-download mr-2"></i> Relatório
                                </button>
                            </div>
                        </div>
                    </header>
                    
                    <div className="grid-layout">
                        <div className="table-container">
                            <PowerPlantTable plants={plants} onSelectPlant={handlePlantSelect} />
                        </div>
                        
                        <div className="map-container">
                            <div className="bg-slate-800 rounded-xl p-5 h-full">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold text-white">Mapa do Sistema</h2>
                                    <div className="flex gap-2">
                                        <button className="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded-lg text-sm">
                                            <i className="fas fa-sync-alt mr-1"></i> Atualizar
                                        </button>
                                        <button className="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded-lg text-sm">
                                            <i className="fas fa-layer-group mr-1"></i> Camadas
                                        </button>
                                    </div>
                                </div>
                                <BrazilMap plants={plants} onSelectPlant={handlePlantSelect} />
                            </div>
                        </div>
                        
                        <div className="sidebar">
                            <SystemSummary 
                                plants={plants} 
                                onAutoDispatch={handleAutoDispatch}
                                onApplyChanges={handleApplyChanges}
                            />
                        </div>
                        
                        <div className="cards-container">
                            <div className="bg-slate-800 rounded-xl p-5 h-full">
                                <div className="card-header">
                                    <h2 className="text-xl font-bold text-white">Usinas do Sistema</h2>
                                    <p className="text-slate-400 text-sm">
                                        {plants.length} usinas monitoradas | {plants.filter(b => b.isSwing).length} barra swing
                                    </p>
                                </div>
                                <div className="grid-stack">
                                    {plants.map(plant => (
                                        <div key={plant.id} id={`plant-${plant.id}`}>
                                            <BusCard 
                                                bus={plant} 
                                                onDispatchChange={handleDispatchChange} 
                                            />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        
                        <div className="chart-container">
                            <div className="bg-slate-800 rounded-xl p-5 h-full">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold text-white">Fluxo de Energia entre Subsistemas</h2>
                                    <div className="text-sm text-slate-400">
                                        Dados em tempo real | Atualizado: agora
                                    </div>
                                </div>
                                <div className="sankey-chart">
                                    <div className="flex flex-wrap gap-4">
                                        {flowData.map((flow, index) => (
                                            <div key={index} className="flex items-center">
                                                <div className="w-8 h-8 rounded-full flex items-center justify-center" style={{ backgroundColor: regionColors[flow.source] }}>
                                                    <span className="text-xs font-bold">{flow.source.charAt(0)}</span>
                                                </div>
                                                <div className="mx-2 text-amber-400">
                                                    <i className="fas fa-arrow-right"></i>
                                                </div>
                                                <div className="w-8 h-8 rounded-full flex items-center justify-center" style={{ backgroundColor: regionColors[flow.target] }}>
                                                    <span className="text-xs font-bold">{flow.target.charAt(0)}</span>
                                                </div>
                                                <div className="ml-2">
                                                    <span className="font-bold">{flow.value.toLocaleString('pt-BR')}</span>
                                                    <span className="text-slate-400 text-sm"> MW</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-6 grid grid-cols-3 gap-4">
                                        {Object.entries(regionColors).map(([region, color]) => (
                                            <div key={region} className="flex items-center">
                                                <div className="w-4 h-4 rounded-full mr-2" style={{ backgroundColor: color }}></div>
                                                <span className="text-sm">{region}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <footer className="mt-8 text-center text-slate-500 text-sm">
                        <p>Operador Nacional do Sistema Elétrico (ONS) - Painel de Controle © 2025</p>
                        <p className="mt-1">Sistema Interligado Nacional - Dados atualizados em tempo real</p>
                    </footer>
                </div>
            );
        };

        // Renderizar a aplicação
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
